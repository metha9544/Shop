<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>METIST - Flower & Luck</title>
    
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" type="image/png" href="logo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="METIST">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --pink: #f8c8dc;
            --pink-dark: #d48398;
            --purple: #e6d9ff;
            --purple-dark: #9b5de5;
            --green: #d9f5e3;
            --bg: #fdf2f7;
            --text: #5a3d45;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 15px;
            color: var(--text);
        }

        .header { text-align: center; margin-bottom: 15px; }
        .header h1 { color: var(--pink-dark); margin: 0; font-size: 1.8rem; }
        .header p { color: #bca0a0; margin: 0; font-size: 0.8rem; letter-spacing: 2px; }

        .nav-menu { display: flex; gap: 5px; margin-bottom: 20px; }
        .nav-menu button {
            flex: 1; padding: 10px 2px; border: 1px solid #f2cbd3; border-radius: 12px;
            background: white; color: var(--pink-dark); font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); cursor: pointer; font-size: 11px;
        }
        .nav-menu button.active { background: var(--pink); color: white; border-color: var(--pink); }
        .en-sub { display: block; font-size: 8px; font-weight: normal; opacity: 0.8; }

        .page { display: none; }
        .page.active { display: block; }
        .card { 
            background: #fff; 
            border-radius: 20px; 
            padding: 18px; 
            margin-bottom: 15px; 
            box-shadow: 0 8px 20px rgba(212, 131, 152, 0.12);
            position: relative;
        }
        h2 { font-size: 1.1rem; margin-top: 0; margin-bottom: 12px; }
        
        .btn-reset-mini {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #eee;
            color: #888;
            border: none;
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-reset-mini:active { background: #ddd; }

        .input-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
        input { 
            width: 100%; 
            padding: 12px; 
            border-radius: 14px; 
            border: 1px solid #f2cbd3; 
            box-sizing: border-box; 
            font-size: 16px; 
        }
        .shipping-input { width: 100px; flex-shrink: 0; }

        .flower-flex-container { display: flex; justify-content: space-between; flex-wrap: nowrap; gap: 5px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .color-item { flex: 0 0 60px; text-align: center; min-width: 60px; cursor: pointer; }
        .color-btn { 
            width: 45px; height: 45px; border-radius: 50%; 
            border: 2px solid #fff; outline: 1px solid #eee;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
            margin: 0 auto; display: block; 
        }
        .count { font-size: 9px; margin-top: 5px; font-weight: bold; line-height: 1.2; }

        .type-selector { display: flex; gap: 10px; background: #fff0f3; padding: 8px; border-radius: 12px; justify-content: center; margin-bottom: 15px; font-size: 13px; }
        .grid-options { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .square-btn { 
            border: 1px solid rgba(0,0,0,0.05); border-radius: 10px; padding: 10px 2px; 
            color: #fff; cursor: pointer; font-size: 11px; font-weight: bold; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .order-item { background: white; border-radius: 18px; padding: 15px; margin-bottom: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .btn-group { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
        .status-btn { border: none; border-radius: 10px; padding: 8px 10px; color: white; font-weight: bold; cursor: pointer; font-size: 11px; }

        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; }
        .summary-box { padding: 12px 5px; border-radius: 15px; text-align: center; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .summary-box span { display: block; font-size: 10px; margin-bottom: 3px; }
        
        .split-sales-container { display: flex; gap: 10px; margin-bottom: 15px; }
        .split-box { flex: 1; padding: 8px; border-radius: 12px; text-align: center; background: #ffd1dc; color: #fff; text-shadow: 1px 1px 0px rgba(0,0,0,0.1); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .split-box span { display: block; font-size: 10px; font-weight: bold; }
        .split-box div { font-size: 18px; font-weight: bold; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px 5px; text-align: center; font-size: 13px; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #888; font-weight: normal; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); overflow-y: auto; }
        .modal-content { background: white; width: 85%; max-width: 320px; margin: 40px auto; padding: 20px; border-radius: 25px; text-align: center; }
        
        /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à */
        .receipt-border { 
            border: 2px dashed var(--pink-dark); 
            border-radius: 20px; 
            padding: 20px; 
            width: 100%; 
            box-sizing: border-box; 
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center; /* ‡∏à‡∏±‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
        }
        
        .receipt-details { width: 100%; text-align: left; font-size: 0.9rem; line-height: 1.7; margin: 15px 0; border-top: 1px solid #f2f2f2; padding-top: 10px; }
        
        /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô QR ‡πÅ‡∏•‡∏∞‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì */
        #receipt-extras {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin-top: 5px;
        }
    </style>
</head>
<body>

<div class="header">
    <h1>üå∏ METIST ‚ú®</h1>
    <p>FLOWER & LUCK</p>
</div>

<div class="nav-menu">
    <button id="btn-flower" class="active" onclick="switchPage('flower')">‡∏™‡∏±‡πà‡∏á‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ <span class="en-sub">Flower</span></button>
    <button id="btn-bracelet" onclick="switchPage('bracelet')">‡∏™‡∏±‡πà‡∏á‡∏Å‡∏≥‡πÑ‡∏• <span class="en-sub">Bracelet</span></button>
    <button id="btn-orders" onclick="switchPage('orders')">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå <span id="nav-pending" style="color:red"></span><span class="en-sub">Order List</span></button>
    <button id="btn-summary" onclick="switchPage('summary')">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î <span class="en-sub">Summary</span></button>
</div>

<div id="page-flower" class="page active">
    <div class="input-row">
        <input id="customer" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...">
        <input id="ship-flower" type="number" class="shipping-input" placeholder="‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á" oninput="calcTotal()">
    </div>
    <div class="card">
        <h2>üåπ ‡∏™‡∏µ‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ</h2>
        <button class="btn-reset-mini" onclick="resetPart('flowers')">‡∏•‡πâ‡∏≤‡∏á</button>
        <div class="type-selector">
            <label><input type="radio" name="flowerType" value="‡∏Å‡∏£‡∏¥‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡πå" checked onchange="renderFlowers()"> ‡∏™‡∏µ‡∏Å‡∏£‡∏¥‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡πå</label>
            <label><input type="radio" name="flowerType" value="‡∏û‡∏∑‡πâ‡∏ô" onchange="renderFlowers()"> ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô</label>
        </div>
        <div class="flower-flex-container" id="flower-grid"></div>
        <input id="basePrice" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ä‡πà‡∏≠ (‡∏ö‡∏≤‡∏ó)" oninput="calcTotal()">
    </div>
    <div class="card">
        <h2>üì¶ ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏´‡πà‡∏≠</h2>
        <button class="btn-reset-mini" onclick="resetPart('papers')">‡∏•‡πâ‡∏≤‡∏á</button>
        <div class="grid-options" id="paper-grid"></div>
        <div id="paperChoice" style="margin-top:8px; font-size:12px; font-weight:bold; color:var(--pink-dark)">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: -</div>
    </div>
    <div class="card">
        <h2>üéÄ ‡πÇ‡∏ö‡∏ß‡πå</h2>
        <button class="btn-reset-mini" onclick="resetPart('bows')">‡∏•‡πâ‡∏≤‡∏á</button>
        <div class="grid-options" id="bow-grid"></div>
        <div id="bowChoice" style="margin-top:8px; font-size:12px; font-weight:bold; color:var(--pink-dark)">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: -</div>
    </div>
    <div class="card">
        <h2>‚ú® ‡∏Ç‡∏≠‡∏á‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á</h2>
        <button class="btn-reset-mini" onclick="resetPart('extras')">‡∏•‡πâ‡∏≤‡∏á</button>
        <div class="grid-options" id="extra-grid"></div>
        <div id="extraChoice" style="margin-top:8px; font-size:12px; font-weight:bold; color:var(--pink-dark)">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: -</div>
    </div>
    <div class="card" style="text-align:center; background: #fff0f3; border: 2px dashed var(--pink);">
        <h2 id="summary-text" style="margin-bottom:0;">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°: 0 ‡∏ö‡∏≤‡∏ó</h2>
    </div>
    <button id="btn-save-flower" onclick="saveOrder('‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ')" style="width:100%; background:var(--pink-dark); color:white; padding:15px; border:none; border-radius:18px; font-size:18px; font-weight:bold; cursor:pointer; margin-top:10px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
</div>

<div id="page-bracelet" class="page">
    <div class="input-row">
        <input id="customer-br" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...">
        <input id="ship-br" type="number" class="shipping-input" placeholder="‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á" oninput="calcBrTotal()">
    </div>
    <div class="card">
        <h2>üîÆ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏¥‡∏ô (Lucky Stone)</h2>
        <button class="btn-reset-mini" onclick="resetBracelet()">‡∏•‡πâ‡∏≤‡∏á</button>
        <div class="flower-flex-container">
            <div class="color-item" onclick="addStone('Rose Quartz')"><div class="color-btn" style="background: #eec9d2;"></div><div class="count">Rose Quartz</div></div>
            <div class="color-item" onclick="addStone('Jadiete')"><div class="color-btn" style="background: #a8e6cf;"></div><div class="count">Jadiete</div></div>
            <div class="color-item" onclick="addStone('Amethyst')"><div class="color-btn" style="background: #b39ddb;"></div><div class="count">Amethyst</div></div>
            <div class="color-item" onclick="addStone('Pyrite')"><div class="color-btn" style="background: #d4af37;"></div><div class="count">Pyrite</div></div>
            <div class="color-item" onclick="addStone('Aquamarine')"><div class="color-btn" style="background: #add8e6;"></div><div class="count">Aquamarine</div></div>
            <div class="color-item" onclick="addStone('Unakite')"><div class="color-btn" style="background: #9ab973;"></div><div class="count">Unakite</div></div>
        </div>
        <div id="stoneChoice" style="margin-top:8px; font-size:12px; font-weight:bold; color:var(--pink-dark)">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏¥‡∏ô: -</div>
    </div>
    <div class="card">
        <h2>‚õìÔ∏è ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÇ‡∏ã‡πà (Chain)</h2>
        <div class="grid-options">
            <div onclick="setChain('‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà 1')" style="cursor:pointer; text-align:center;"><img src="001.png" width="45" height="45" style="border-radius:8px; border:1px solid #eee;"><div style="font-size:9px;">‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà 1</div></div>
            <div onclick="setChain('‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà 2')" style="cursor:pointer; text-align:center;"><img src="002.png" width="45" height="45" style="border-radius:8px; border:1px solid #eee;"><div style="font-size:9px;">‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà 2</div></div>
            <div onclick="setChain('‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà 3')" style="cursor:pointer; text-align:center;"><img src="003.png" width="45" height="45" style="border-radius:8px; border:1px solid #eee;"><div style="font-size:9px;">‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà 3</div></div>
            <div onclick="setChain('‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà 4 (‡∏™‡∏µ‡∏ó‡∏≠‡∏á)')" style="cursor:pointer; text-align:center;"><img src="004.png" width="45" height="45" style="border-radius:8px; border:1px solid #eee;"><div style="font-size:9px;">‡∏™‡∏µ‡∏ó‡∏≠‡∏á +10‡∏ø</div></div>
        </div>
        <div id="chainChoice" style="margin-top:8px; font-size:12px; font-weight:bold; color:var(--pink-dark)">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡πà: -</div>
        <div style="margin-top:15px;">
            <label style="font-size: 13px; font-weight: bold;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠ (cm):</label>
            <input type="number" id="wrist-size" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠">
        </div>
    </div>
    <div class="card">
        <h2>üîí ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡πá‡∏≠‡∏Ñ</h2>
        <div class="grid-options">
            <button class="square-btn" style="background:#bca0a0;" onclick="setLock('‡∏´‡πà‡∏ß‡∏á', 0)">‡∏´‡πà‡∏ß‡∏á (‡∏ü‡∏£‡∏µ)</button>
            <button class="square-btn" style="background:#f8c8dc; color:#5a3d45;" onclick="setLock('‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ', 10)">‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ (+10‡∏ø)</button>
        </div>
        <div id="lockChoice" style="margin-top:8px; font-size:12px; font-weight:bold; color:var(--pink-dark)">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡πá‡∏≠‡∏Ñ: -</div>
    </div>
    <div class="card">
        <h2>‚ú® ‡∏Ç‡∏≠‡∏á‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á (Accessories)</h2>
        <div class="grid-options">
            <button class="square-btn" style="background:#eee; color:#333;" onclick="addAccessory('‡∏à‡∏µ‡πâ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÄ‡∏á‡∏¥‡∏ô')">‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÄ‡∏á‡∏¥‡∏ô</button>
            <button class="square-btn" style="background:#fae1a5; color:#333;" onclick="addAccessory('‡∏à‡∏µ‡πâ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏ó‡∏≠‡∏á')">‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏ó‡∏≠‡∏á</button>
            <button class="square-btn" style="background:#eee; color:#333;" onclick="addAccessory('‡∏à‡∏µ‡πâ‡∏î‡∏≤‡∏ß‡πÄ‡∏á‡∏¥‡∏ô')">‡∏î‡∏≤‡∏ß‡πÄ‡∏á‡∏¥‡∏ô</button>
            <button class="square-btn" style="background:#fae1a5; color:#333;" onclick="addAccessory('‡∏à‡∏µ‡πâ‡∏î‡∏≤‡∏ß‡∏ó‡∏≠‡∏á')">‡∏î‡∏≤‡∏ß‡∏ó‡∏≠‡∏á</button>
            <button class="square-btn" style="background:#fff; color:#333; border:1px solid #ddd;" onclick="addAccessory('‡πÑ‡∏Ç‡πà‡∏°‡∏∏‡∏Å')">‡πÑ‡∏Ç‡πà‡∏°‡∏∏‡∏Å</button>
        </div>
        <div id="accList" style="margin-top:8px; font-size:11px; color:#888;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: -</div>
    </div>
    <div class="card" style="text-align:center; background: #fdf2f7; border: 2px dashed var(--pink-dark);">
        <h2 id="br-summary-text" style="margin-bottom:0;">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°: 59 ‡∏ö‡∏≤‡∏ó</h2>
    </div>
    <button id="btn-save-br" onclick="saveOrder('‡∏Å‡∏≥‡πÑ‡∏•')" style="width:100%; background:var(--pink-dark); color:white; padding:15px; border:none; border-radius:18px; font-size:18px; font-weight:bold; cursor:pointer; margin-top:10px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Å‡∏≥‡πÑ‡∏•</button>
</div>

<div id="page-orders" class="page">
    <div class="card">
        <h2 style="margin-bottom:10px;">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
        <input type="text" id="searchOrder" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." oninput="renderOrderList()" style="margin-bottom:0;">
    </div>
    <div style="display:flex; justify-content:space-between; align-items: center; padding:0 10px; margin-bottom:10px;">
        <div>
            <span id="pending-count" style="font-size:0.8rem; font-weight:bold; color:var(--pink-dark);"></span>
            <button onclick="showTaskSummary()" style="margin-left:10px; padding:5px 12px; background:var(--pink); border:none; border-radius:10px; color:var(--text); font-size:11px; font-weight:bold; cursor:pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥</button>
        </div>
        <span style="font-size:0.7rem; color:gray;">üå∏ ‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ | üîÆ ‡∏Å‡∏≥‡πÑ‡∏•</span>
    </div>
    <div id="order-list"></div>
</div>

<div id="page-summary" class="page">
    <div class="summary-grid">
        <div class="summary-box" style="background:var(--green)"><span>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</span><div id="stat-sale">0</div></div>
        <div class="summary-box" style="background:var(--purple)"><span>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</span><div id="stat-cost">0</div></div>
        <div class="summary-box" style="background:var(--pink)"><span>‡∏Å‡∏≥‡πÑ‡∏£</span><div id="stat-profit">0</div></div>
    </div>
    
    <div class="split-sales-container">
        <div class="split-box"><span>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ</span><div id="stat-flower-sale">0</div></div>
        <div class="split-box" style="background:var(--purple-dark)"><span>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏Å‡∏≥‡πÑ‡∏•</span><div id="stat-bracelet-sale">0</div></div>
    </div>

    <div class="card" style="margin-bottom:15px; border: 1px solid #eee;">
        <h3 style="font-size: 0.9rem; margin-bottom: 10px; color: #888; text-align: center;">üìä ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡∏£‡∏ß‡∏°‡∏°‡∏±‡∏î‡∏à‡∏≥)</h3>
        <table style="width: 100%; font-size: 12px;">
            <thead>
                <tr style="background: #fdf2f7;">
                    <th style="text-align: left;">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                    <th style="color: #51cf66;">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</th>
                    <th style="color: #ff6b6b;">‡∏¢‡∏±‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="text-align: left;">üå∏ ‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ</td>
                    <td id="pay-flower-done" style="font-weight: bold; color: #51cf66;">0</td>
                    <td id="pay-flower-pending" style="font-weight: bold; color: #ff6b6b;">0</td>
                </tr>
                <tr>
                    <td style="text-align: left;">üîÆ ‡∏Å‡∏≥‡πÑ‡∏•</td>
                    <td id="pay-br-done" style="font-weight: bold; color: #51cf66;">0</td>
                    <td id="pay-br-pending" style="font-weight: bold; color: #ff6b6b;">0</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="card" style="border: 1px solid var(--pink); background: #fff5f8;">
        <h3>üíæ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Backup)</h3>
        <div style="display: flex; gap: 10px;">
            <button onclick="exportData()" style="flex: 1; background: #51cf66; color: white; padding: 12px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer;">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button onclick="document.getElementById('importFile').click()" style="flex: 1; background: #fab005; color: white; padding: 12px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer;">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
        <input type="file" id="importFile" style="display:none" accept=".json" onchange="importData(event)">
    </div>

    <div class="card">
        <h3>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h3>
        <input type="text" id="cost-desc" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
        <input type="number" id="cost-amount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">
        <button onclick="addCost()" style="width:100%; background:var(--purple); padding:12px; border:none; border-radius:12px; font-weight:bold; cursor: pointer;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</button>
    </div>
    
    <div class="card">
        <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h3>
        <table id="cost-table">
            <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏¢‡∏≠‡∏î</th><th>‡∏•‡∏ö</th></tr></thead>
            <tbody id="cost-history-body"></tbody>
        </table>
    </div>
</div>

<div id="receiptModal" class="modal">
    <div class="modal-content">
        <div class="receipt-border">
            <h2 id="receipt-title" style="color:var(--pink-dark); margin-bottom:5px;">üå∏ METIST ‚ú®</h2>
            <div id="rc-date" style="font-size: 11px; color: #888;"></div>
            <div class="receipt-details" id="modal-body"></div>
            <div id="receipt-extras">
                <img src="qr.png" width="130">
                <p style="font-size: 10px; color: #888; margin-top: 10px;">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏≠‡∏∏‡∏î‡∏´‡∏ô‡∏∏‡∏ôüíê</p>
            </div>
        </div>
        <button onclick="shareReceipt()" style="width:100%; background:#d48398; color:white; padding:12px; border:none; border-radius:15px; margin-top:15px; font-weight:bold;">Save</button>
        <button onclick="closeModal()" style="width:100%; background:#5a3d45; color:white; padding:12px; border:none; border-radius:15px; margin-top:10px; font-weight:bold;">‡∏õ‡∏¥‡∏î</button>
    </div>
</div>

<script>
    let orders = JSON.parse(localStorage.getItem("metist_orders") || "[]");
    let costs = JSON.parse(localStorage.getItem("metist_costs") || "[]");
    let orderBeingEdited = null;

    const colors = { ‡πÅ‡∏î‡∏á: "#e63946", ‡∏Ç‡∏≤‡∏ß: "#ffffff", ‡∏ä‡∏°‡∏û‡∏π: "#f7b2cc", ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô: "#457b9d", ‡∏°‡πà‡∏ß‡∏á: "#9b5de5", ‡∏î‡∏≥: "#333333", ‡∏ä‡∏°‡∏û‡∏π‡πÅ‡∏Å‡πâ‡∏ß: "#ff007f", ‡πÅ‡∏î‡∏á‡πÅ‡∏Å‡πâ‡∏ß: "#b91d1d" };
    const extraPrice = { ‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠: 5, ‡∏°‡∏á‡∏Å‡∏∏‡∏é: 10, ‡πÑ‡∏üLED: 25, ‡πÑ‡∏Ç‡πà‡∏°‡∏∏‡∏Å: 0, ‡∏Ç‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡πÑ‡∏°‡πâ: 0, ‡∏Ç‡∏≠‡∏ö‡∏°‡∏∏‡∏Å: 0, ‡∏Å‡∏≤‡∏£‡πå‡∏î: 0 };

    let currentFlowerData = { "‡∏û‡∏∑‡πâ‡∏ô": {}, "‡∏Å‡∏£‡∏¥‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡πå": {} };
    let selectedPapers = []; 
    let selectedBows = []; 
    let selectedExtras = {};
    let brData = { stones: {}, chain: "", lock: "", lockPrice: 0, chainPrice: 0, accessories: [], basePrice: 59, wristSize: "" };

    const cleanPrice = (val) => typeof val === 'number' ? val : parseFloat(String(val).replace(/[^0-9.]/g, '')) || 0;

    function resetPart(part) {
        if (part === 'flowers') {
            currentFlowerData = { "‡∏û‡∏∑‡πâ‡∏ô": {}, "‡∏Å‡∏£‡∏¥‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡πå": {} };
            renderFlowers();
        } else if (part === 'papers') {
            selectedPapers = [];
            document.getElementById('paperChoice').innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: -";
        } else if (part === 'bows') {
            selectedBows = [];
            document.getElementById('bowChoice').innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: -";
        } else if (part === 'extras') {
            selectedExtras = {};
            document.getElementById('extraChoice').innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: -";
        }
        calcTotal();
    }

    function switchPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-menu button').forEach(b => b.classList.remove('active'));
        document.getElementById('page-' + pageId).classList.add('active');
        document.getElementById('btn-' + pageId).classList.add('active');
        if(pageId === 'orders') renderOrderList();
        if(pageId === 'summary') renderSummary();
        updatePendingNav();
    }

    // --- Flower Functions ---
    function renderFlowers() {
        const flowerList = ["‡πÅ‡∏î‡∏á", "‡∏Ç‡∏≤‡∏ß", "‡∏ä‡∏°‡∏û‡∏π", "‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô", "‡∏°‡πà‡∏ß‡∏á"];
        document.getElementById("flower-grid").innerHTML = flowerList.map(c => `
            <div class="color-item" onclick="addFlower('${c}')">
                <div class="color-btn" style="background:${colors[c]}"></div>
                <div class="count">${c}<br>‡∏û‡∏∑‡πâ‡∏ô:${currentFlowerData["‡∏û‡∏∑‡πâ‡∏ô"][c]||0} ‡∏Å‡∏£‡∏¥‡∏ï:${currentFlowerData["‡∏Å‡∏£‡∏¥‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡πå"][c]||0}</div>
            </div>`).join("");
    }

    function addFlower(color) {
        const type = document.querySelector('input[name="flowerType"]:checked').value;
        currentFlowerData[type][color] = (currentFlowerData[type][color] || 0) + 1;
        renderFlowers(); calcTotal();
    }

    function renderExtraChoice() {
        let selectedList = Object.keys(selectedExtras).filter(e => selectedExtras[e] > 0);
        document.getElementById('extraChoice').innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: " + (selectedList.join(", ") || "-");
    }

    function calcTotal() {
        let base = Number(document.getElementById("basePrice").value || 0);
        let ship = Number(document.getElementById("ship-flower").value || 0);
        let extraTotal = 0;
        Object.keys(selectedExtras).forEach(e => extraTotal += (selectedExtras[e] * extraPrice[e]));
        let total = base + extraTotal + ship;
        document.getElementById("summary-text").innerText = `‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°: ${total} ‡∏ö‡∏≤‡∏ó`;
        return total;
    }

    // --- Bracelet Functions ---
    function addStone(name) { brData.stones[name] = (brData.stones[name] || 0) + 1; renderStoneList(); calcBrTotal(); }
    function renderStoneList() {
        let sel = []; for (let s in brData.stones) { if (brData.stones[s] > 0) sel.push(`${s}x${brData.stones[s]}`); }
        document.getElementById('stoneChoice').innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏¥‡∏ô: " + (sel.join(", ") || "-");
    }
    function setChain(n) { brData.chain = n; brData.chainPrice = n.includes('‡∏ó‡∏≠‡∏á') ? 10 : 0; document.getElementById('chainChoice').innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: "+n; calcBrTotal(); }
    function setLock(n, p) { brData.lock = n; brData.lockPrice = p; document.getElementById('lockChoice').innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: "+n; calcBrTotal(); }
    function addAccessory(n) { brData.accessories.push(n); document.getElementById('accList').innerText = "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: " + brData.accessories.join(","); calcBrTotal(); }
    function calcBrTotal() {
        let total = brData.basePrice;
        let ship = Number(document.getElementById("ship-br").value || 0);
        let sCount = Object.values(brData.stones).reduce((a, b) => a + b, 0);
        if (sCount > 1) total += (sCount - 1) * 30;
        total += brData.lockPrice + brData.chainPrice;
        let normal = 0, pearl = 0;
        brData.accessories.forEach(i => i === '‡πÑ‡∏Ç‡πà‡∏°‡∏∏‡∏Å' ? pearl++ : normal++);
        if (normal > 1) total += (normal - 1) * 5;
        if (pearl > 1) total += (pearl - 1) * 5;
        total += ship;
        document.getElementById("br-summary-text").innerText = `‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°: ${total} ‡∏ö‡∏≤‡∏ó`;
        return total;
    }

    function resetBracelet() {
        brData = { stones: {}, chain: "", lock: "", lockPrice: 0, chainPrice: 0, accessories: [], basePrice: 59, wristSize: "" };
        document.getElementById('stoneChoice').innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏¥‡∏ô: -"; document.getElementById('chainChoice').innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡πà: -";
        document.getElementById('lockChoice').innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡πá‡∏≠‡∏Ñ: -"; document.getElementById('accList').innerText = "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: -";
        document.getElementById('wrist-size').value = ""; document.getElementById('ship-br').value = ""; calcBrTotal();
        document.getElementById("btn-save-br").innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Å‡∏≥‡πÑ‡∏•";
    }

    // --- Order Logic ---
    function saveOrder(productType) {
        let name, total, details, shipping;
        if(productType === '‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ') {
            name = document.getElementById("customer").value;
            shipping = Number(document.getElementById("ship-flower").value || 0);
            total = calcTotal();
            details = { flowers: JSON.parse(JSON.stringify(currentFlowerData)), paper: selectedPapers.join(", "), bow: selectedBows.join(", "), extras: {...selectedExtras}, basePrice: document.getElementById("basePrice").value };
        } else {
            name = document.getElementById("customer-br").value;
            shipping = Number(document.getElementById("ship-br").value || 0);
            total = calcBrTotal();
            brData.wristSize = document.getElementById('wrist-size').value;
            details = JSON.parse(JSON.stringify(brData));
        }

        if(!name) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"); return; }

        if (orderBeingEdited !== null) {
            orders[orderBeingEdited] = { ...orders[orderBeingEdited], name, total, shipping, details };
            orderBeingEdited = null;
        } else {
            orders.push({ id: Date.now(), name, type: productType, total, shipping, details, date: new Date().toLocaleDateString('th-TH'), status: false, paid: false, deposit: 0 });
        }

        updateStore();
        if(productType === '‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ') {
            document.getElementById("customer").value = ""; document.getElementById("ship-flower").value = "";
            resetPart('flowers'); resetPart('papers'); resetPart('bows'); resetPart('extras');
            document.getElementById("basePrice").value = ""; 
            document.getElementById("btn-save-flower").innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå";
        } else {
            resetBracelet(); document.getElementById("customer-br").value = "";
        }
        switchPage('orders');
    }

    function editOrder(index) {
        const o = orders[index];
        orderBeingEdited = index;
        if (o.type === '‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ') {
            switchPage('flower');
            document.getElementById("customer").value = o.name;
            document.getElementById("ship-flower").value = o.shipping;
            document.getElementById("basePrice").value = o.details.basePrice || "";
            currentFlowerData = JSON.parse(JSON.stringify(o.details.flowers));
            selectedPapers = o.details.paper ? o.details.paper.split(",").filter(x => x.trim() !== "") : [];
            selectedBows = o.details.bow ? o.details.bow.split(",").filter(x => x.trim() !== "") : [];
            selectedExtras = {...o.details.extras};
            document.getElementById("paperChoice").innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: " + (o.details.paper || "-");
            document.getElementById("bowChoice").innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: " + (o.details.bow || "-");
            renderFlowers(); renderExtraChoice(); calcTotal();
            document.getElementById("btn-save-flower").innerText = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)";
        } else {
            switchPage('bracelet');
            document.getElementById("customer-br").value = o.name;
            document.getElementById("ship-br").value = o.shipping;
            document.getElementById("wrist-size").value = o.details.wristSize;
            brData = JSON.parse(JSON.stringify(o.details));
            renderStoneList();
            document.getElementById('chainChoice').innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: " + (brData.chain || "-");
            document.getElementById('lockChoice').innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: " + (brData.lock || "-");
            document.getElementById('accList').innerText = "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: " + (brData.accessories.join(",") || "-");
            calcBrTotal();
            document.getElementById("btn-save-br").innerText = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Å‡∏≥‡πÑ‡∏• (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)";
        }
    }

    function renderOrderList() {
        const listDiv = document.getElementById("order-list");
        const search = document.getElementById("searchOrder").value.toLowerCase();
        let filtered = orders.filter(o => o.name.toLowerCase().includes(search));
        filtered.sort((a, b) => (a.status !== b.status) ? (a.status ? 1 : -1) : (b.id - a.id));
        document.getElementById("pending-count").innerText = `‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£: ${orders.filter(o => !o.status).length}`;
        listDiv.innerHTML = filtered.map((o) => {
            const realIdx = orders.findIndex(orig => orig.id === o.id);
            const isFlower = o.type === '‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ';
            const accent = isFlower ? '#d48398' : '#9b5de5';
            const bg = isFlower ? '#fff5f8' : '#f9f5ff';
            const total = cleanPrice(o.total), deposit = o.deposit || 0, remaining = total - deposit;
            return `<div class="order-item" style="border-left: 8px solid ${accent}; background: ${bg};">
                    <div style="display:flex; justify-content:space-between; font-size:11px; font-weight:bold; color:${accent}">
                        <span>${isFlower ? 'üå∏ FLOWER' : 'üîÆ BRACELET'} ${o.status ? '‚úÖ' : '‚è≥'}</span>
                        <span style="color:gray">${o.date}</span>
                    </div>
                    <div style="margin:5px 0"><b>üë§ ${o.name}</b> ${o.shipping > 0 ? `<small style="color:#ff6b6b">(‡∏™‡πà‡∏á +${o.shipping})</small>` : ''}</div>
                    <div style="font-weight:bold">‡∏¢‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${total.toLocaleString()} ‡∏ø</div>
                    ${deposit > 0 ? `<div style="font-size:11px; color:#666;">‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÅ‡∏•‡πâ‡∏ß: <span style="color:#51cf66; font-weight:bold;">${deposit.toLocaleString()} ‡∏ø</span></div><div style="font-size:11px; color:#ff6b6b; margin-bottom:5px;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b>${remaining.toLocaleString()} ‡∏ø</b></div>` : ''}
                    <div class="btn-group" style="margin-top:10px;"><button class="status-btn" style="background:${o.status ? '#51cf66' : '#ff6b6b'}; flex:1" onclick="toggleStatus(${realIdx})">${o.status ? '‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß' : '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}</button><button class="status-btn" style="background:${o.paid ? '#51cf66' : '#ff6b6b'}; flex:1" onclick="togglePaid(${realIdx})">${o.paid ? '‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö'}</button></div>
                    <div class="btn-group"><button class="status-btn" style="background:white; color:${accent}; border:1px solid ${accent}; flex:1" onclick="setDeposit(${realIdx})">‡∏°‡∏±‡∏î‡∏à‡∏≥</button><button class="status-btn" style="background:white; color:${accent}; border:1px solid ${accent}; flex:1" onclick="openPopup(${realIdx}, 'order')">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button><button class="status-btn" style="background:white; color:${accent}; border:1px solid ${accent}; flex:1" onclick="openPopup(${realIdx}, 'receipt')">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button></div>
                    <div class="btn-group"><button class="status-btn" style="background:white; color:${accent}; border:1px solid ${accent}; flex:1" onclick="editOrder(${realIdx})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button><button class="status-btn" style="background:#eee; color:#999; width:35px" onclick="deleteOrder(${realIdx})">üóëÔ∏è</button></div>
                </div>`;
        }).join("");
    }

    function openPopup(i, mode) {
        const o = orders[i]; const isReceipt = mode === 'receipt';
        const total = cleanPrice(o.total), deposit = o.deposit || 0, remaining = total - deposit;
        const shipping = Number(o.shipping || 0);
        const productSubtotal = total - shipping; 

        document.getElementById("receipt-title").innerText = isReceipt ? "METIST" : "üå∏ METIST ‚ú®";
        let body = isReceipt ? `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ‡∏Ñ‡∏∏‡∏ì ${o.name}<br>` : `üë§ <b>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</b> ${o.name}<br>`;
        
        if (o.type === '‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ') {
            let fTxt = []; for (let t in o.details.flowers) { for (let c in o.details.flowers[t]) if (o.details.flowers[t][c] > 0) fTxt.push(`${c}${t==='‡∏Å‡∏£‡∏¥‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡πå'?'(‡∏Å‡∏£‡∏¥‡∏ï)':''} x${o.details.flowers[t][c]}`); }
            let exTxt = Object.keys(o.details.extras).filter(ex => o.details.extras[ex] > 0);
            body += isReceipt ? `‡∏™‡∏µ‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ: ${fTxt.join(", ") || "-"}<br>‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©: ${o.details.paper || "-"}<br>‡πÇ‡∏ö‡∏ß‡πå: ${o.details.bow || "-"}<br>‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á: ${exTxt.join(", ") || "-"}` : `üåπ <b>‡∏™‡∏µ‡∏î‡∏≠‡∏Å:</b> ${fTxt.join(", ") || "-"}<br>üì¶ <b>‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©:</b> ${o.details.paper || "-"}<br>üéÄ <b>‡πÇ‡∏ö‡∏ß‡πå:</b> ${o.details.bow || "-"}<br>‚ú® <b>‡∏Ç‡∏≠‡∏á‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á:</b> ${exTxt.join(", ") || "-"}`;
        } else {
            let sTxt = []; for (let s in o.details.stones) if (o.details.stones[s] > 0) sTxt.push(`${s}x${o.details.stones[s]}`);
            body += isReceipt ? `‡∏´‡∏¥‡∏ô: ${sTxt.join(", ")}<br>‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠: ${o.details.wristSize || "-"} cm<br>‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà: ${o.details.accessories.join(", ") || "-"}` : `üîÆ <b>‡∏´‡∏¥‡∏ô:</b> ${sTxt.join(", ")}<br>üìè <b>‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠:</b> ${o.details.wristSize || "-"} cm<br>‚ú® <b>‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà:</b> ${o.details.accessories.join(", ") || "-"}`;
        }

        body += `<br>`;

        if (shipping > 0) {
            body += `<br>${isReceipt ? '‡∏Ñ‡πà‡∏≤‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ:' : 'üíê <b>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</b>'} ${productSubtotal.toLocaleString()} ‡∏ø`;
            body += `<br>${isReceipt ? '‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:' : 'üöö <b>‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:</b>'} ${shipping.toLocaleString()} ‡∏ø`;
        }

        body += `<br><b style="font-size:1.1rem; color:var(--pink-dark)">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${total.toLocaleString()} ‡∏ø</b>`;
        
        if (deposit > 0) { 
            body += `<br>${isReceipt ? '‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÅ‡∏•‡πâ‡∏ß:' : '<span style="color:#51cf66;">‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÅ‡∏•‡πâ‡∏ß:</span>'} ${deposit.toLocaleString()} ‡∏ø`; 
            if(!o.paid) body += `<br><b style="color:#ff6b6b;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${remaining.toLocaleString()} ‡∏ø</b>`; 
        }
        
        document.getElementById("rc-date").innerText = "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: " + o.date;
        document.getElementById("modal-body").innerHTML = body;
        document.getElementById("receipt-extras").style.display = isReceipt ? "flex" : "none";
        document.getElementById("receiptModal").style.display = "block";
    }

    // --- ‡πÅ‡∏ä‡∏£‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à ---
    async function shareReceipt() {
        const receiptElement = document.querySelector(".receipt-border");
        const container = document.createElement('div');
        container.style.width = '375px';
        container.style.height = '500px'; 
        container.style.display = 'flex';
        container.style.flexDirection = 'column';
        container.style.alignItems = 'center';
        container.style.justifyContent = 'center';
        container.style.padding = '20px';
        container.style.background = '#fdf2f7'; 
        container.style.position = 'fixed';
        container.style.top = '-9999px';

        const clone = receiptElement.cloneNode(true);
        clone.style.width = '100%';
        clone.style.margin = '0';
        clone.style.background = 'white';
        container.appendChild(clone);
        document.body.appendChild(container);

        try {
            const canvas = await html2canvas(container, { scale: 2 });
            document.body.removeChild(container);
            
            canvas.toBlob(async (blob) => {
                const file = new File([blob], 'METIST_Receipt.png', { type: 'image/png' });
                if (navigator.share && navigator.canShare({ files: [file] })) {
                    await navigator.share({ files: [file], title: '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à METIST' });
                } else {
                    const a = document.createElement('a');
                    a.download = 'METIST_Receipt.png';
                    a.href = canvas.toDataURL();
                    a.click();
                }
            });
        } catch (e) { alert("‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + e); }
    }

    function renderSummary() {
        const totalSales = orders.reduce((s, o) => s + cleanPrice(o.total), 0);
        const fSale = orders.filter(o => o.type === '‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ').reduce((s, o) => s + cleanPrice(o.total), 0);
        const bSale = orders.filter(o => o.type === '‡∏Å‡∏≥‡πÑ‡∏•').reduce((s, o) => s + cleanPrice(o.total), 0);
        const getPaidAmount = (type) => orders.filter(o => o.type === type).reduce((s, o) => s + (o.paid ? cleanPrice(o.total) : (o.deposit || 0)), 0);
        const fPaid = getPaidAmount('‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ'), bPaid = getPaidAmount('‡∏Å‡∏≥‡πÑ‡∏•');
        const cost = costs.reduce((s, c) => s + (Number(c.amount) || 0), 0);
        document.getElementById("stat-sale").innerText = totalSales.toLocaleString();
        document.getElementById("stat-flower-sale").innerText = fSale.toLocaleString();
        document.getElementById("stat-bracelet-sale").innerText = bSale.toLocaleString();
        document.getElementById("stat-cost").innerText = cost.toLocaleString();
        document.getElementById("stat-profit").innerText = (totalSales - cost).toLocaleString();
        document.getElementById("pay-flower-done").innerText = fPaid.toLocaleString();
        document.getElementById("pay-flower-pending").innerText = (fSale - fPaid).toLocaleString();
        document.getElementById("pay-br-done").innerText = bPaid.toLocaleString();
        document.getElementById("pay-br-pending").innerText = (bSale - bPaid).toLocaleString();
        document.getElementById("cost-history-body").innerHTML = [...costs].reverse().map((c, i) => `<tr><td>${c.date}</td><td>${c.desc}</td><td>${Number(c.amount).toLocaleString()}</td><td><button onclick="deleteCost(${costs.length-1-i})" style="border:none; color:red; background:none;">‡∏•‡∏ö</button></td></tr>`).join("");
    }

    function updatePendingNav() { const p = orders.filter(o => !o.status).length; document.getElementById("nav-pending").innerText = p > 0 ? `(${p})` : ""; }
    function toggleStatus(i) { orders[i].status = !orders[i].status; updateStore(); }
    function togglePaid(i) { orders[i].paid = !orders[i].paid; updateStore(); }
    function deleteOrder(i) { if(confirm("‡∏•‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ?")) { orders.splice(i, 1); updateStore(); } }
    function setDeposit(i) { let amt = prompt("‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥:", orders[i].deposit || ""); if (amt !== null) { orders[i].deposit = Number(amt); updateStore(); } }
    function updateStore() { localStorage.setItem("metist_orders", JSON.stringify(orders)); renderOrderList(); updatePendingNav(); }
    function addCost() { const d = document.getElementById("cost-desc").value, a = document.getElementById("cost-amount").value; if(!a) return; costs.push({ desc: d||"‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ", amount: a, date: new Date().toLocaleDateString('th-TH') }); localStorage.setItem("metist_costs", JSON.stringify(costs)); renderSummary(); document.getElementById("cost-desc").value = ""; document.getElementById("cost-amount").value = ""; }
    function deleteCost(i) { costs.splice(i,1); localStorage.setItem("metist_costs", JSON.stringify(costs)); renderSummary(); }
    function closeModal() { document.getElementById("receiptModal").style.display = "none"; }
    function exportData() { const blob = new Blob([JSON.stringify({ orders, costs })], { type: "application/json" }); const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `METIST_Backup.json`; a.click(); }
    function importData(e) { const reader = new FileReader(); reader.onload = (ev) => { const data = JSON.parse(ev.target.result); if (confirm("‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?")) { localStorage.setItem("metist_orders", JSON.stringify(data.orders)); localStorage.setItem("metist_costs", JSON.stringify(data.costs)); location.reload(); } }; reader.readAsText(e.target.files[0]); }

    function showTaskSummary() {
        const pendingOrders = orders.filter(o => !o.status);
        if (pendingOrders.length === 0) { alert("‡πÄ‡∏¢‡πâ! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏≥‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ üå∏"); return; }
        let flowerSummary = {}; let stoneSummary = {};
        pendingOrders.forEach(o => {
            if (o.type === '‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ') {
                const flowers = o.details.flowers;
                for (let type in flowers) {
                    for (let color in flowers[type]) {
                        if (flowers[type][color] > 0) {
                            const key = `${color} (${type})`;
                            flowerSummary[key] = (flowerSummary[key] || 0) + flowers[type][color];
                        }
                    }
                }
            } else if (o.type === '‡∏Å‡∏≥‡πÑ‡∏•') {
                const stones = o.details.stones;
                for (let stone in stones) { if (stones[stone] > 0) stoneSummary[stone] = (stoneSummary[stone] || 0) + stones[stone]; }
            }
        });
        let summaryHtml = `<div style="text-align:left; font-size:14px;"><p><b>üì¶ ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${pendingOrders.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</b></p><hr>`;
        if (Object.keys(flowerSummary).length > 0) {
            summaryHtml += `<p><b>üåπ ‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°:</b></p><ul>`;
            for (let f in flowerSummary) summaryHtml += `<li>${f}: ${flowerSummary[f]} ‡∏î‡∏≠‡∏Å</li>`;
            summaryHtml += `</ul>`;
        }
        if (Object.keys(stoneSummary).length > 0) {
            summaryHtml += `<p><b>üîÆ ‡∏´‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ:</b></p><ul>`;
            for (let s in stoneSummary) summaryHtml += `<li>${s}: ${stoneSummary[s]} ‡πÄ‡∏°‡πá‡∏î</li>`;
            summaryHtml += `</ul>`;
        }
        summaryHtml += `</div>`;
        document.getElementById("receipt-title").innerText = "üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°";
        document.getElementById("rc-date").innerText = "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: " + new Date().toLocaleDateString('th-TH');
        document.getElementById("modal-body").innerHTML = summaryHtml;
        document.getElementById("receipt-extras").style.display = "none";
        document.getElementById("receiptModal").style.display = "block";
    }

    // --- Init UI Grid ---
    document.getElementById("paper-grid").innerHTML = ["‡∏î‡∏≥", "‡∏Ç‡∏≤‡∏ß", "‡∏ä‡∏°‡∏û‡∏π", "‡πÅ‡∏î‡∏á"].map(c => `<button class="square-btn" style="background:${colors[c]}; color:${c==='‡∏Ç‡∏≤‡∏ß'?'#555':'#fff'}" onclick="selectedPapers.push('${c}'); document.getElementById('paperChoice').innerText='‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: '+selectedPapers.join(',')">${c}</button>`).join("");
    document.getElementById("bow-grid").innerHTML = ["‡πÅ‡∏î‡∏á", "‡∏Ç‡∏≤‡∏ß", "‡∏ä‡∏°‡∏û‡∏π", "‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô", "‡∏°‡πà‡∏ß‡∏á", "‡∏ä‡∏°‡∏û‡∏π‡πÅ‡∏Å‡πâ‡∏ß", "‡πÅ‡∏î‡∏á‡πÅ‡∏Å‡πâ‡∏ß"].map(c => `<button class="square-btn" style="background:${colors[c]}; color:${c==='‡∏Ç‡∏≤‡∏ß'?'#555':'#fff'}" onclick="selectedBows.push('${c}'); document.getElementById('bowChoice').innerText='‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: '+selectedBows.join(',')">${c}</button>`).join("");
    document.getElementById("extra-grid").innerHTML = Object.keys(extraPrice).map(e => `<button class="square-btn" style="background:#f2b5d4; color:#5a3d45;" onclick="selectedExtras['${e}']=(selectedExtras['${e}']||0)+1; calcTotal(); renderExtraChoice();">${e}+${extraPrice[e]}</button>`).join("");

    renderFlowers();
    updatePendingNav();
</script>
</body>
</html>